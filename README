==================================================================================================
 ImageToolBox: a set of small tools for image processing
==================================================================================================

This project contains simple command line tools to process image files.
Most code parts were automatically generated by LLMs such as ChatGPT and Gemini.

Most tools support JPEG/TIFF/PNG as input files and output files.  The format is determined by
the file extension (.jpg, .tif, .tiff, .png).

Python3 is required to run scripts.  Required libraries are the following.

  OpenCV2, NumPy, ExifRead

To install them, run the following command.

  $ pip3 pip3 install opencv-contrib-python numpy exifread

Optionally, those tools can be executed implicitly.

  ExifTool

----------------

itb_stack : Stack and merge images into one.

This command is useful to make pseudo-STF images and HDR images.

For pseudo-STF (smooth transfer focus), take multiple images with various apertures.  If you can
use aperture bracketing or do it manually, just input the images.  They are stacked and merged
into a image by weighted average composition.

  $ itb_stack input*.jpg -o output.jpg

Actually, using weighted average composition is better for pseudo-STR.  The weight of each image
is calculated as the radius of circle of confusion.  It means that images take with wider aperture
contribute more to the final image.

  $ itb_stack input*.jpg -o output.jpg -m w

Most cameras support exposure bracketting.  If you use it on the S mode with a fixed ISO, images
are taken with various apertures but exposure is different.  Then, set -ax option, which adjusts
exposure of each input image before merging.
  
  $ itb_stack input*.jpg -o output.jpg -ax -m w

If bracketting is done hand-held without a tripod.  Pictures will be shifted a little, which
causes blur after merging.  In that case, aligning input images is useful.  In most cases, SIFT
aligner is best suited.

  $ itb_stack input*.jpg -o output.jpg -ax -m w -a s

To make a HDR (high dynamic range) image from images taken by exposure bracketting, run the
following command.  It merges input images by Debevec method and apply tone mapping by Reinhard
method.

  $ itb_stack input*.jpg -o output.jpg -m d -t r

Aligning images is also useful to make HDR images of hand-held taken pictures.

  $ itb_stack input*.jpg -o output.jpg -m d -t r -a s

By default, brightness of the merged image is calibrated to match the average brightness of the
input images.  If you calibrate brightness youself, suppress it.

  $ itb_stack input*.jpg -o output.jpg -nr

You can adjust brightness and contrast of the merged image manually.

  $ itb_stack input*.jpg -o output.jpg --slog 1.3 --sigmoid 2.4

Merging multiple picutures taken with high sensitivity is effective to suppress noise.  If the
number of pictures ais less than 20, use median instead of average.  Moreover, ignoring unaligned
images from merging is a practical solution against failures of aligning pictures.

  $ itb_stack input*.jpg -o output.jpg -m median -a s -iu

Focus stacking of images taken with different focus distance is also supported.  In this case,
using ECC aligner is sometimes better than SIFT.

  $ itb_stack input*.jpg -o output.jpg -m f -nr -a e

Stitching images as a panorama image is also supported.

  $ itb_stack input*.jpg -o output.jpg -m s -nr -fm

Yo can trim and scale the merged image.  For trimming, you set percentages for each edge like
margin spec in CSS (top,right,bottom,left).  Fos scaling, you set both the width and height, or
just the longer side of the new image.

  $ itb_stack input*.jpg -o output.jpg --trim "30,20,30,20" --trim "1920,1080"
  $ itb_stack input*.jpg -o output.jpg --trim "30,20" --trim "1920"

You can put a caption on the merged image.  By default, the font size is 20% of sqrt(area); the
font color is white; the position is center.

  $ itb_stack input*.jpg -o output.jpg --caption "hello"

You can change the size, color, and position.  The following set the size 0.5, the color #ff0,
and the position bottom-left.

  $ itb_stack input*.jpg -o output.jpg --caption "hello|0.5|ff0|bl"

If "exiftool" command is available on your system, EXIF metadata and ICC profile of the first
input image is conveyed to the merged image.

You can make a video file from the input images, you specify the FPS (frames per second) of the
video.  Supported formats are MP4 and MOV (.mp4 and .mov).

  $ itb_stack input*.jpg -o output.mp4 --video 0.5

The following mergeing methods are supported.

  - average (a) : average composition (default)
  - weighted (w) : weighted average composition, suitable for pseudo-STF
  - median (mdn) : median composition, suitable for noise reduction
  - minimum (min) : minimum value composition, suitable to moving light sources
  - maximum (max) : maximum value composition, suitable for star trailing
  - debevec (d) : Debevec's method, to make an HDR image, for natural result
  - robertson (r) : Robertson's method, to make an HDR image, for the most recognizable shapes
  - mergens (m) : Mergen's method, to make a pseudo-HDR image by blending
  - focus (f) : focus stacking using Laplacian filter
  - stitch (s) : to make a panorama image

Only devebec supports tone mapping for postprocessing.  The following methods are supported.

  - linear (l) : linear conversion
  - reinhard (r) : Reinhard's method, based on human recognition model
  - drago (d) : Drago's method, based on logarithmic model
  - mantuik (m) : Mentuik's method, maximizing local contrast to enhance detail

The following aligning methods are supported.

  - none : to do nothing (default)
  - orb (o) : ORB, fast but less accurate
  - sift (s) : SIFT, slow but more accurate, robust to scale and rotation too
  - ecc (e) : ECC, good balance, optimized to small shifts from camera shake
  - hugin (h) : to call Hugin's align_image_stack as an external command

In summary, to make a peudo-STF image, averaging exposure and weighted average composition make
the best result in most cases.

  $ itb_stack input*.jpg -o output.jpg -ax -m w -a s

To make an HDR image, combining Debevec and Robertson methods makes the best result in most cases.

  $ itb_stack input*.jpg -o output.jpg -m d -t r -a s

To reduce effect of camera shake during bracketting shoot, utilizing an alignment method is
recommended.  Usually SIFT is recommended as in the above examples.  However, each method has
its pros and cons.  Thus, try different ones: SIFT, ORB, ECC, and Hugin in sequence.

== END OF FILE ==
