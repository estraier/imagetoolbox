==================================================================================================
 ImageToolBox: a set of small tools for image processing
==================================================================================================

This project contains simple command line tools to process image files.
Most code parts were automatically generated by LLMs such as ChatGPT and Gemini.

Most tools support JPEG/TIFF/PNG as input files and output files.  The format is determined by
the file extension (.jpg, .tif, .tiff, .png).

Python3 is required to run scripts.  Required libraries are the following.

  OpenCV2, NumPy, ExifRead

To install them, run the following command.

  $ pip3 install opencv-python-headless numpy exifread

Optionally, those tools can be executed implicitly.

  ExifTool

----------------

itb_stack.py : Stack and merge images into one.

This command is useful to create pseudo-STF images, HDR images, less-noise images, focus-stacked
images, panoramic images, and videos.

For pseudo-STF (smooth transfer focus), take multiple images with various apertures.  If you can
use aperture bracketing or do it manually, simply input the images.  They are stacked and merged
into an image by average composition.

  $ itb_stack.py input*.jpg -o output.jpg

In fact, weighted average composition is more suitable for pseudo-STF.  The weight of each image
is calculated as the radius of the circle of confusion.  It means that images taken with wider
aperture contribute more to the final image.

  $ itb_stack.py input*.jpg -o output.jpg -m w

Most cameras support exposure bracketing.  If you use it on the S mode with a fixed ISO, images
are taken with various apertures but exposure is different.  Then, set -ax option, which adjusts
exposure of each input image before merging.

  $ itb_stack.py input*.jpg -o output.jpg -ax -m w

If bracketing is done handheld without a tripod, pictures will be shifted a little, which
causes blur after merging.  In that case, aligning input images is useful.  In most cases, the
SIFT aligner is the best option.

  $ itb_stack.py input*.jpg -o output.jpg -ax -m w -a s

To create an HDR (high dynamic range) image from images taken by exposure bracketing, run the
following command.  It merges input images by Debevec's method and applies tone mapping by
Reinhard's method.

  $ itb_stack.py input*.jpg -o output.jpg -m d -t r

Alignment is also useful for creating HDR images of handheld pictures.

  $ itb_stack.py input*.jpg -o output.jpg -m d -t r -a s

By default, brightness of the merged image is calibrated to match the average brightness of the
input images.  If you calibrate brightness yourself, suppress it.

  $ itb_stack.py input*.jpg -o output.jpg -nr

You can adjust brightness and contrast of the merged image manually.

  $ itb_stack.py input*.jpg -o output.jpg --slog 1.3 --sigmoid 2.4

Merging multiple pictures taken with high sensitivity is effective in suppressing noise.  If the
number of pictures is less than 20, use median instead of average.  Moreover, ignoring unaligned
images from merging is a practical solution against failures of aligning pictures.

  $ itb_stack.py input*.jpg -o output.jpg -m median -a s -iu

Focus stacking of images taken with different focus distance is also supported.  In this case,
using ECC aligner is sometimes better than SIFT.

  $ itb_stack.py input*.jpg -o output.jpg -m f -nr -a e

Stitching images as a panoramic image is also supported.  "-fm" fills the black margin.

  $ itb_stack.py input*.jpg -o output.jpg -m s -nr -fm

You can trim and scale the merged image.  For trimming, you set percentages for each edge like
margin spec in CSS (top,right,bottom,left).  For scaling, you set both the width and height, or
just the longer side of the new image.  Perspective correction by specifying four coordinate
points is also supported.

  $ itb_stack.py input*.jpg -o output.jpg --trim "30,20,30,20" --scale "1920,1080"
  $ itb_stack.py input*.jpg -o output.jpg --trim "30,20" --scale "1920"
  $ itb_stack.py input*.jpg -o output.jpg --pers "10,10,90,10,100,100,0,100"

You can put a caption on the merged image.  By default, the font size is 20% of sqrt(area); the
font color is white; the position is center.

  $ itb_stack.py input*.jpg -o output.jpg --caption "hello"

You can change the size, color, and position.  The following sets the size 0.5, the color #ff0,
and the position bottom-left.

  $ itb_stack.py input*.jpg -o output.jpg --caption "hello|0.5|ff0|bl"

If "exiftool" command is available on your system, EXIF metadata and ICC profile of the first
input image are preserved in the merged image.

If the output file name has an extension of videos (.mp4 and .mov), a video whose frames are
the input images is created.  You can specify the FPS (frames per second).

  $ itb_stack.py input*.jpg -o output.mp4 --output-video-fps 0.5

If each input file name has an extension of videos (.mp4 and .mov), frames are extracted as
input images.  You can specify the FPS (frames per second).

  $ itb_stack.py input.mp4 -o output.jpg --input-video-fps 0.5

The following merging methods are supported.

  - average (a) : average composition (default)
  - median (mdn) : median composition, suitable for noise reduction
  - minimum (min) : minimum value composition, suitable for dynamic light sources
  - maximum (max) : maximum value composition, suitable for star trailing
  - weighted (w) : weighted average composition, suitable for pseudo-STF
  - debevec (d) : Debevec's method, to create an HDR image, for a natural result
  - robertson (r) : Robertson's method, to create an HDR image, for the most recognizable shapes
  - mergens (m) : Mergen's method, to create a pseudo-HDR image by blending
  - focus (f) : focus stacking using Laplacian filter
  - stitch (s) : to create a panoramic image

Debevec, Robertson, and Mergen support tone mapping for post-processing.  The following methods
are supported.

  - linear (l) : linear conversion
  - reinhard (r) : Reinhard's method, based on human recognition model
  - drago (d) : Drago's method, based on logarithmic model
  - mantiuk (m) : Mantiuk's method, maximizing local contrast to enhance detail

The following aligning methods are supported.

  - none : to do nothing (default)
  - orb (o) : ORB, fast but less accurate
  - sift (s) : SIFT, slow but more accurate, robust to scale and rotation too
  - ecc (e) : ECC, good balance, optimized to small shifts from camera shake
  - hugin (h) : to call Hugin's align_image_stack as an external command

In summary, to create a pseudo-STF image, averaging exposure and weighted average composition
produces the best results in most cases.

  $ itb_stack.py input*.jpg -o output.jpg -ax -m w -a s

To create an HDR image, combining the Debevec and Robertson methods produces the best results in
most cases.

  $ itb_stack.py input*.jpg -o output.jpg -m d -t r -a s

The focus stacking algorithm uses softmax of local contrast for composition weight.  It is an
interesting fact that this algorithm is useful to create HDR images.  Averaging exposure and
applying focus stacking produces contrasty and natural images.

  $ itb_stack.py input*.jpg -o output.jpg -ax -m f -a s

To reduce the effect of camera shake during a bracketing shoot, utilizing an alignment method is
recommended.  Usually SIFT is recommended as in the above examples.  However, each method has
its pros and cons.  Thus, try different ones: SIFT, ORB, ECC, and Hugin in sequence.

For unit testing, run the following command.

  $ ./test_itb_stack.py

== END OF FILE ==
